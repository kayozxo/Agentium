<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Agentium</title>

    <link
      rel="stylesheet"
      href="styles.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <div class="container">
      <header
        class="header"
        id="headerTop"
      >
        <div class="logo">
          <div class="logo-icon">
            <svg
              width="150"
              height="150"
              viewBox="0 0 150 150"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle
                cx="75"
                cy="75"
                r="6"
                fill="#121212"
              />
              <ellipse
                cx="75"
                cy="75"
                rx="40"
                ry="20"
                stroke="#121212"
                stroke-width="2"
                fill="none"
              />
              <ellipse
                cx="75"
                cy="75"
                rx="20"
                ry="40"
                stroke="#121212"
                stroke-width="2"
                fill="none"
                transform="rotate(45 75 75)"
              />
              <ellipse
                cx="75"
                cy="75"
                rx="20"
                ry="40"
                stroke="#121212"
                stroke-width="2"
                fill="none"
                transform="rotate(-45 75 75)"
              />
            </svg>
          </div>
          Agentium
        </div>
      </header>

      <main class="main-content">
        <div
          class="hero-section"
          id="heroSection"
        >
          <h1 class="hero-title">Chat Smarter, Not Harder</h1>
          <p class="hero-subtitle">
            Agentium gives you access to task-specific agents all in one chat
            interface.
          </p>
        </div>

        <div
          class="chat-container"
          id="chatContainer"
        >
          <div class="chat-header">
            <div
              class="chat-header-icon"
              id="chatHeaderIcon"
            >
              ðŸ’¬
            </div>
            <div class="chat-header-text">
              <h3 id="agentTitle">General Chat</h3>
              <p id="agentDescription">Ask me anything!</p>
            </div>
          </div>

          <div
            class="messages-container"
            id="messages"
          >
            <div class="welcome-message">
              <h4>Welcome to AI Agent Hub!</h4>
              <p>Select an agent and start your conversation.</p>
            </div>
          </div>
        </div>

        <div class="input-section">
          <div class="input-controls">
            <div
              class="custom-dropdown"
              id="agentDropdown"
            >
              <button
                class="dropdown-button"
                id="dropdownButton"
              >
                <div
                  class="dropdown-selected"
                  id="dropdownSelected"
                >
                  <i class="bi bi-chat-dots"></i>
                  <span>General</span>
                </div>
                <i class="bi bi-caret-down-fill dropdown-arrow"></i>
              </button>
              <div
                class="dropdown-menu"
                id="dropdownMenu"
              >
                <div
                  class="dropdown-option selected"
                  data-value="general"
                >
                  <i class="bi bi-chat-dots"></i>
                  <span>General</span>
                </div>
                <div
                  class="dropdown-option"
                  data-value="web"
                >
                  <i class="bi bi-globe2"></i>
                  <span>Web Search</span>
                </div>
                <div
                  class="dropdown-option"
                  data-value="youtube"
                >
                  <i class="bi bi-youtube"></i>
                  <span>YouTube</span>
                </div>
                <div
                  class="dropdown-option"
                  data-value="articles"
                >
                  <i class="bi bi-file-text"></i>
                  <span>Articles</span>
                </div>
                <div
                  class="dropdown-option"
                  data-value="linkedin"
                >
                  <i class="bi bi-linkedin"></i>
                  <span>LinkedIn</span>
                </div>
                <div
                  class="dropdown-option"
                  data-value="finance"
                >
                  <i class="bi bi-currency-dollar"></i>
                  <span>Finance</span>
                </div>
              </div>
            </div>

            <div class="file-upload-container">
              <button
                class="file-upload-btn"
                id="imageUploadBtn"
              >
                <i class="bi bi-image"></i> Image
                <input
                  type="file"
                  class="file-input"
                  id="imageInput"
                  accept="image/*"
                  multiple
                />
              </button>
              <button
                class="file-upload-btn"
                id="fileUploadBtn"
              >
                <i class="bi bi-file-earmark"></i> File
                <input
                  type="file"
                  class="file-input"
                  id="fileInput"
                  multiple
                />
              </button>
            </div>
          </div>

          <div
            class="uploaded-files"
            id="uploadedFiles"
          ></div>

          <div class="input-wrapper">
            <textarea
              class="chat-input"
              id="messageInput"
              placeholder="Ask Agentium to create a LinkedIn post about..."
              rows="1"
            ></textarea>
            <button
              class="send-button"
              id="sendButton"
              disabled
            >
              <i class="bi bi-arrow-up"></i>
            </button>
          </div>
        </div>
      </main>
    </div>

    <script>
      class CustomDropdown {
        constructor(element) {
          this.dropdown = element
          this.button = element.querySelector('.dropdown-button')
          this.menu = element.querySelector('.dropdown-menu')
          this.selected = element.querySelector('.dropdown-selected')
          this.options = element.querySelectorAll('.dropdown-option')
          this.isOpen = false

          this.init()
        }

        init() {
          // Toggle dropdown on button click
          this.button.addEventListener('click', (e) => {
            e.stopPropagation()
            this.toggle()
          })

          // Handle option selection
          this.options.forEach((option) => {
            option.addEventListener('click', (e) => {
              e.stopPropagation()
              this.selectOption(option)
            })
          })

          // Close dropdown when clicking outside
          document.addEventListener('click', () => {
            this.close()
          })

          // Close dropdown on escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              this.close()
            }
          })
        }

        toggle() {
          if (this.isOpen) {
            this.close()
          } else {
            this.open()
          }
        }

        open() {
          this.isOpen = true
          this.button.classList.add('active')
          this.menu.classList.add('active')
        }

        close() {
          this.isOpen = false
          this.button.classList.remove('active')
          this.menu.classList.remove('active')
        }

        selectOption(option) {
          // Remove selected class from all options
          this.options.forEach((opt) => opt.classList.remove('selected'))

          // Add selected class to clicked option
          option.classList.add('selected')

          // Update the button display
          const icon = option.querySelector('i').className
          const text = option.querySelector('span').textContent

          this.selected.innerHTML = `
            <i class="${icon}"></i>
            <span>${text}</span>
          `

          // Close dropdown
          this.close()

          // Trigger change event
          const changeEvent = new CustomEvent('change', {
            detail: {
              value: option.dataset.value,
              text: text,
              icon: icon,
            },
          })
          this.dropdown.dispatchEvent(changeEvent)
        }

        getValue() {
          const selectedOption = this.dropdown.querySelector(
            '.dropdown-option.selected',
          )
          return selectedOption ? selectedOption.dataset.value : null
        }

        setValue(value) {
          const option = this.dropdown.querySelector(`[data-value="${value}"]`)
          if (option) {
            this.selectOption(option)
          }
        }
      }

      class ChatApp {
        constructor() {
          this.currentAgent = 'general'
          this.apiUrl = 'http://localhost:8000'
          this.messages = []
          this.isLoading = false
          this.uploadedFiles = []
          this.isChatStarted = false

          this.initializeElements()
          this.initializeDropdown()
          this.bindEvents()
          this.updatePlaceholder()
        }

        initializeElements() {
          this.heroSection = document.getElementById('heroSection')
          this.headerTop = document.getElementById('headerTop')
          this.chatContainer = document.getElementById('chatContainer')
          this.messagesContainer = document.getElementById('messages')
          this.messageInput = document.getElementById('messageInput')
          this.sendButton = document.getElementById('sendButton')
          this.agentTitle = document.getElementById('agentTitle')
          this.agentDescription = document.getElementById('agentDescription')
          this.chatHeaderIcon = document.getElementById('chatHeaderIcon')
          this.imageInput = document.getElementById('imageInput')
          this.fileInput = document.getElementById('fileInput')
          this.imageUploadBtn = document.getElementById('imageUploadBtn')
          this.fileUploadBtn = document.getElementById('fileUploadBtn')
          this.uploadedFilesContainer = document.getElementById('uploadedFiles')
        }

        initializeDropdown() {
          const dropdownElement = document.getElementById('agentDropdown')
          this.agentDropdown = new CustomDropdown(dropdownElement)

          // Listen for dropdown changes
          dropdownElement.addEventListener('change', (e) => {
            this.selectAgent(e.detail.value)
          })
        }

        bindEvents() {
          // File uploads
          this.imageUploadBtn.addEventListener('click', () => {
            this.imageInput.click()
          })

          this.fileUploadBtn.addEventListener('click', () => {
            this.fileInput.click()
          })

          this.imageInput.addEventListener('change', (e) => {
            this.handleFileUpload(e.target.files, 'image')
          })

          this.fileInput.addEventListener('change', (e) => {
            this.handleFileUpload(e.target.files, 'file')
          })

          // Send message
          this.sendButton.addEventListener('click', () => this.sendMessage())

          this.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault()
              this.sendMessage()
            }
          })

          // Auto-resize textarea and enable/disable send button
          this.messageInput.addEventListener('input', () => {
            this.autoResizeTextarea()
            this.sendButton.disabled =
              !this.messageInput.value.trim() && this.uploadedFiles.length === 0
          })
        }

        startChat() {
          this.isChatStarted = true
          if (this.heroSection) this.heroSection.style.display = 'none'
          if (this.headerTop) this.headerTop.style.display = 'none'
          if (this.chatContainer) this.chatContainer.style.display = 'block'
        }

        selectAgent(agentType) {
          this.currentAgent = agentType
          const agentInfo = this.getAgentInfo(agentType)
          this.agentTitle.textContent = agentInfo.title
          this.agentDescription.textContent = agentInfo.description

          // Clear and add Bootstrap icon
          this.chatHeaderIcon.innerHTML = ''
          const icon = document.createElement('i')
          icon.className = agentInfo.icon
          this.chatHeaderIcon.appendChild(icon)

          this.updatePlaceholder()
          if (this.isChatStarted) {
            this.clearMessages()
          }
        }

        updatePlaceholder() {
          const placeholders = {
            general: 'Ask me anything...',
            web: 'Search the web...',
            youtube: 'Find YouTube videos about...',
            articles: 'Research articles on...',
            linkedin: 'Find LinkedIn insights about...',
            finance: 'Get financial data for...',
          }
          this.messageInput.placeholder =
            placeholders[this.currentAgent] || 'Type your message...'
        }

        getAgentInfo(agentType) {
          const agentInfoMap = {
            general: {
              title: 'General Chat',
              description: 'Ask me anything!',
              icon: 'bi bi-chat-dots',
            },
            web: {
              title: 'Web Agent',
              description: 'Search and browse the web',
              icon: 'bi bi-globe2',
            },
            youtube: {
              title: 'YouTube Agent',
              description: 'Find YouTube content',
              icon: 'bi bi-youtube',
            },
            articles: {
              title: 'Articles Agent',
              description: 'Research articles',
              icon: 'bi bi-file-text',
            },
            linkedin: {
              title: 'LinkedIn Agent',
              description: 'Professional insights',
              icon: 'bi bi-linkedin',
            },
            finance: {
              title: 'Finance Agent',
              description: 'Financial analysis',
              icon: 'bi bi-currency-dollar',
            },
          }
          return agentInfoMap[agentType] || agentInfoMap.general
        }

        handleFileUpload(files, type) {
          Array.from(files).forEach((file) => {
            const fileObj = {
              id: Date.now() + Math.random(),
              file: file,
              type: type,
              name: file.name,
            }
            this.uploadedFiles.push(fileObj)
            this.renderUploadedFiles()
          })
          this.sendButton.disabled =
            !this.messageInput.value.trim() && this.uploadedFiles.length === 0
        }

        renderUploadedFiles() {
          this.uploadedFilesContainer.innerHTML = ''
          this.uploadedFiles.forEach((fileObj) => {
            const chip = document.createElement('div')
            chip.className = 'file-chip'
            chip.innerHTML = `
              <span>${
                fileObj.type === 'image'
                  ? '<i class="bi bi-image"></i>'
                  : '<i class="bi bi-file-earmark"></i>'
              } ${fileObj.name}</span>
              <span class="remove-file" data-id="${fileObj.id}">Ã—</span>
            `

            chip.querySelector('.remove-file').addEventListener('click', () => {
              this.removeFile(fileObj.id)
            })

            this.uploadedFilesContainer.appendChild(chip)
          })
        }

        removeFile(fileId) {
          this.uploadedFiles = this.uploadedFiles.filter((f) => f.id !== fileId)
          this.renderUploadedFiles()
          this.sendButton.disabled =
            !this.messageInput.value.trim() && this.uploadedFiles.length === 0
        }

        autoResizeTextarea() {
          this.messageInput.style.height = 'auto'
          this.messageInput.style.height =
            Math.min(this.messageInput.scrollHeight, 120) + 'px'
        }

        async sendMessage() {
          const message = this.messageInput.value.trim()
          if (this.isLoading) return
          if (!message && this.uploadedFiles.length === 0) return

          if (!this.isChatStarted) {
            this.startChat()
          }

          // Add user message
          let displayMessage = message
          if (this.uploadedFiles.length > 0) {
            const fileList = this.uploadedFiles.map((f) => f.name).join(', ')
            displayMessage = `${message}\nðŸ“Ž Files: ${fileList}`
          }
          this.addMessage(displayMessage || 'ðŸ“Ž Files uploaded', 'user')

          // Clear input
          this.messageInput.value = ''
          this.uploadedFiles = []
          this.renderUploadedFiles()
          this.sendButton.disabled = true
          this.autoResizeTextarea()

          // Show loading
          this.showLoading()

          try {
            // For now, we'll just send the text query
            // In a real implementation, you'd handle file uploads differently
            const response = await fetch(`${this.apiUrl}/agent/ask`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                agent: this.currentAgent,
                query: message || 'Files uploaded',
              }),
            })

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`)
            }

            const data = await response.json()
            this.hideLoading()
            this.addMessage(data.response, 'bot')
          } catch (error) {
            this.hideLoading()
            this.showError(`Failed to get response: ${error.message}`)
          }
        }

        addMessage(content, sender) {
          const messageDiv = document.createElement('div')
          messageDiv.className = `message ${sender}`

          const avatar = document.createElement('div')
          avatar.className = 'message-avatar'
          avatar.textContent = sender === 'user' ? 'U' : 'AI'

          const messageContent = document.createElement('div')
          messageContent.className = 'message-content'

          const formattedContent = this.formatMessage(content)
          messageContent.innerHTML = formattedContent

          messageDiv.appendChild(avatar)
          messageDiv.appendChild(messageContent)

          const welcomeMessage =
            this.messagesContainer.querySelector('.welcome-message')
          if (welcomeMessage) {
            welcomeMessage.remove()
          }

          this.messagesContainer.appendChild(messageDiv)
          this.scrollToBottom()
        }

        formatMessage(content) {
          // Basic markdown formatting with proper HTML rendering
          let formatted = content
            // Bold text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Italic text
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // Inline code
            .replace(
              /`(.*?)`/g,
              '<code style="background: #333; padding: 2px 4px; border-radius: 3px; color: #FFBE1A;">$1</code>',
            )
            // Headers
            .replace(
              /^### (.*$)/gm,
              '<h3 style="color: #FFBE1A; font-size: 16px; font-weight: 600; margin: 12px 0 8px 0;">$1</h3>',
            )
            .replace(
              /^## (.*$)/gm,
              '<h2 style="color: #FFBE1A; font-size: 18px; font-weight: 600; margin: 16px 0 8px 0;">$1</h2>',
            )
            .replace(
              /^# (.*$)/gm,
              '<h1 style="color: #FFBE1A; font-size: 20px; font-weight: 600; margin: 16px 0 8px 0;">$1</h1>',
            )
            // Line breaks
            .replace(/\n/g, '<br>')
            // Lists (basic implementation)
            .replace(
              /^\* (.*$)/gm,
              '<li style="margin-left: 20px; margin-bottom: 4px;">$1</li>',
            )
            .replace(
              /^- (.*$)/gm,
              '<li style="margin-left: 20px; margin-bottom: 4px;">$1</li>',
            )
            // Links - [text](url) format
            .replace(
              /\[([^\]]+)\]\(([^)]+)\)/g,
              "<a href='$2' target='_blank' style='color: #FFBE1A; text-decoration: underline; cursor: pointer;'>$1</a>",
            )
            // Auto-detect URLs (http/https)
            .replace(
              /(https?:\/\/[^\s<>"{}|\\^`[\]]+)/g,
              "<a href='$1' target='_blank' style='color: #FFBE1A; text-decoration: underline; cursor: pointer;'>$1</a>",
            )

          // Wrap consecutive <li> elements in <ul>
          formatted = formatted.replace(
            /(<li[^>]*>.*?<\/li>)(?:\s*<li[^>]*>.*?<\/li>)*/gs,
            function (match) {
              return (
                '<ul style="margin: 8px 0; padding-left: 0; list-style: none;">' +
                match.replace(
                  /<li/g,
                  '<li style="margin-left: 20px; margin-bottom: 4px; position: relative;',
                ) +
                '</ul>'
              )
            },
          )

          return formatted
        }

        showLoading() {
          this.isLoading = true
          const loadingDiv = document.createElement('div')
          loadingDiv.className = 'message bot'
          loadingDiv.id = 'loading-message'

          const avatar = document.createElement('div')
          avatar.className = 'message-avatar'
          avatar.textContent = 'AI'

          const loadingContent = document.createElement('div')
          loadingContent.className = 'message-content'
          loadingContent.innerHTML = `
            <div class="loading">
              <div class="loading-dot"></div>
              <div class="loading-dot"></div>
              <div class="loading-dot"></div>
            </div>
          `

          loadingDiv.appendChild(avatar)
          loadingDiv.appendChild(loadingContent)
          this.messagesContainer.appendChild(loadingDiv)
          this.scrollToBottom()
        }

        hideLoading() {
          this.isLoading = false
          const loadingMessage = document.getElementById('loading-message')
          if (loadingMessage) {
            loadingMessage.remove()
          }
        }

        showError(message) {
          const errorDiv = document.createElement('div')
          errorDiv.className = 'error-message'
          errorDiv.textContent = message
          this.messagesContainer.appendChild(errorDiv)
          this.scrollToBottom()

          setTimeout(() => {
            errorDiv.remove()
          }, 5000)
        }

        clearMessages() {
          this.messagesContainer.innerHTML = `
            <div class="welcome-message">
              <h4>Switched to ${this.getAgentInfo(this.currentAgent).title}</h4>
              <p>${this.getAgentInfo(this.currentAgent).description}</p>
            </div>
          `
        }

        scrollToBottom() {
          this.messagesContainer.scrollTo({
            top: this.messagesContainer.scrollHeight,
            behavior: 'smooth',
          })
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        new ChatApp()
      })
    </script>
  </body>
</html>
